{% extends 'base.html' %}

{% block content %}
<div class="alert alert-info alert-dismissible fade show d-flex justify-content-between align-items-center flex-wrap gap-2 border border-dark" style="background-color:white;" role="alert">
    <p class="mb-0">
      Welcome to the task archive page! Here, you will be able to view all tasks that either manually or automatically archived. Tasks that are fully completed and past their deadline will be automatically archived and added to this page. You may also manually archive a task from the task page. 
    </p>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>  



<div class="container mt-4">
    <div class="card p-4 shadow">
                <!-- Filter tasks form -->
        <div class="filter-form mb-3">
            <form method="get" name="filter_tasks" class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                {% csrf_token %}
                <label class="form-label">{{ form.user_category_filter.label }}</label>
                <div class="d-flex flex-row gap-3">
                    {% for checkbox in form.user_category_filter %}
                        <div class="form-check">
                            {{ checkbox.tag }}
                            <label class="form-check-label">{{ checkbox.choice_label }}</label>
                        </div>
                    {% endfor %}
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" name="make-filter" class="btn btn-secondary">Filter</button>
                    <button type="button" name="reset-filter" class="btn btn-secondary" onclick="resetFilter()">Reset</button>
                </div>
            </form> 
        </div>

        <h2 class="mb-4">Task Archive</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Due Date</th>
                    <th>Progress</th>
                    <th>Categories</th>
                    <th>Creator</th>
                </tr>
            </thead>
            <tbody>
                {% for task in archived_tasks %}
                <tr>
                    <td>{{ task.name }}</td>
                    <td>{{ task.description }}</td>
                    <td>{{ task.due_date|date:"M d, Y H:i" }}</td>
                    <td>{{ task.progress }}%</td>
                    <td>
                        {% for user in task.assigned_users.all %}
                            <span class="badge bg-secondary">{{ user.username }}</span>
                        {% empty %}
                            <span class="text-muted">None</span>
                        {% endfor %}
                    </td>
                    <td>
                        {% for category in task.categories.all %}
                            <span class="badge bg-secondary">{{ category.name }}</span>
                        {% empty %}
                            <span class="text-muted">None</span>
                        {% endfor %}
                    </td>
                    <td>
                        <a href="{% url 'restore_task' task.id %}" class="btn btn-primary btn-sm">Restore</a>
                        <button class="btn btn-danger btn-sm" onclick="confirmDelete({{ task.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function resetFilter() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
        document.forms['filter_tasks'].submit();
    }
</script>

<script>
    function confirmDelete(taskId) {
        if (confirm("Are you sure you want to permanently delete this task?")) {
            window.location.href = `/tasks/delete/${taskId}/`;
        }
    }
</script>

{% endblock %}
