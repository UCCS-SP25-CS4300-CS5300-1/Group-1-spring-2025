<!DOCTYPE html>
<html>
    <style>
        .nav-hover {
            transition: all 0.2s ease;
            padding: 5px 10px;
        }

        .nav-hover:hover {
            text-decoration: underline;
        }
    </style>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        {% load static %}

        <!-- include bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        
        <!-- include bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" 
            crossorigin="anonymous">
        </script>
         
         <!-- page specific CSS -->
        {% block extra_css %}{% endblock %}

        <title>Base To-Do List</title>
    </head>
    <body class="m-3">
        <div class="collapse" id="navbarToggleExternalContent" style="background-color: #1f4e45;">
            <div class="p-4 container-fluid">
                <h5 class="text-white h4">Navigation Menu</h5>
                <span class="text-muted"></span>
                <ul class="nav flex-column mt-3">
                    <li class="nav-item">
                        <a class="nav-link text-white nav-hover" href="{% url 'index' %}">Welcome</a>

                        {% if user.is_authenticated %}
                        <a class="nav-link text-white nav-hover" href="{% url 'home' %}">Home</a>
                        <a class="nav-link text-white nav-hover" href="{% url 'task_view' %}">Tasks</a>
                        <a class="nav-link text-white nav-hover" href="{% url 'task_archive' %}">Task Archive</a>
                        <a class="nav-link text-white nav-hover" href="{% url 'profile_settings' %}">Profile Settings</a>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
          
        <nav class="navbar navbar-dark" style="height: 80px; background-color: #5b8e85;">
            <div class="container-fluid">
                <a class="navbar-brand" href="#" style="margin-left: 110px; font-size: 2rem;">To-Do List</a>
                <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation" style="margin-right: 110px;">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </nav>

        <div class="container mt-4">
            {% block content %}
            {% endblock %}
        </div>

         <script>
                if ('serviceWorker' in navigator && 'PushManager' in window) {
                    navigator.serviceWorker.register("{% static 'webpush-sw.js' %}")
                        .then(function(registration) {
                            console.log('Service Worker registered with scope:', registration.scope);
                            
                            return registration.pushManager.getSubscription().then(async function(subscription) {
                                if (subscription) return subscription;
            
                                const vapidKey = "{{ vapid_key }}";
                                const convertedVapidKey = urlBase64ToUint8Array(vapidKey);
            
                                return registration.pushManager.subscribe({
                                    userVisibleOnly: true,
                                    applicationServerKey: convertedVapidKey
                                });
                            });
                        })
                        .then(function(subscription) {
                            fetch('/webpush/save_information/', {
                                method: 'POST',
                                body: JSON.stringify(subscription),
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                }
                            }).then(res => res.json()).then(data => {
                                console.log('Push subscription saved:', data);
                            });
                        })
                        .catch(function(error) {
                            console.error('Service Worker registration failed:', error);
                        });
                }
            
                function urlBase64ToUint8Array(base64String) {
                    const padding = '='.repeat((4 - base64String.length % 4) % 4);
                    const base64 = (base64String + padding)
                        .replace(/-/g, '+')
                        .replace(/_/g, '/');
            
                    const rawData = window.atob(base64);
                    return new Uint8Array([...rawData].map(char => char.charCodeAt(0)));
                }
            </script>            
    </body>
</html>
